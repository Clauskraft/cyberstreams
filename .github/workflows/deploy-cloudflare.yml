name: Deploy to Cloudflare Pages

# Triggers:
# - Automatically deploy on push to main branch
# - Allow manual deployment via workflow dispatch
on:
  push:
    branches:
      - main
    # Path filters to avoid unnecessary deployments
    # Only deploy when relevant files change
    paths:
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'package-lock.json'
      - 'vite.config.ts'
      - 'tsconfig.json'
      - 'tailwind.config.js'
      - 'postcss.config.js'
      - '.github/workflows/deploy-cloudflare.yml'
  
  # Allow manual deployment from Actions tab
  workflow_dispatch:

# Security: Grant minimal required permissions
permissions:
  contents: read        # Read repository contents
  deployments: write    # Create deployment status
  id-token: write      # Required for Cloudflare authentication

jobs:
  deploy:
    name: Build and Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout repository code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Step 2: Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Step 3: Install dependencies
      # Use npm ci for clean install if package-lock.json exists, otherwise use npm install
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      # Step 4: Build the Vite React application
      - name: Build production bundle
        run: npm run build
        env:
          NODE_ENV: production

      # Step 5: Deploy to Cloudflare Pages
      # This action deploys the dist directory to Cloudflare Pages
      # Required secrets (configure in repository Settings > Secrets and variables > Actions):
      # - CLOUDFLARE_API_TOKEN: API token with "Cloudflare Pages:Edit" permission
      #   Get your token at: https://dash.cloudflare.com/profile/api-tokens
      #   Required permissions:
      #     * Account → Cloudflare Pages → Edit
      #     * Account → Account Settings → Read
      #     * User → User Details → Read
      # - CLOUDFLARE_ACCOUNT_ID: Your Cloudflare account ID
      #   Account ID for cyberstreams: 23b3799e11009b55048086157faff1a1
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: cyberstreams
          directory: dist
          # Optional: Add git commit info to deployment
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      # Step 6: Output deployment URL (for debugging and verification)
      - name: Deployment completed
        run: |
          echo "✅ Deployment successful!"
          echo "🌐 Your app should be live at: https://cyberstreams.pages.dev"
          echo "📝 Check Cloudflare Dashboard for deployment details"
